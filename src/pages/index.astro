---
import Layout from '../layouts/Layout.astro'

// React components as islands
import { Nav } from '@components/layout/Nav'
import { ScrollProgress } from '@components/effects/ScrollProgress'
import { Hero } from '@components/sections/Hero'
import { VideoInterlude } from '@components/sections/VideoInterlude'
import { CoreThesis } from '@components/sections/CoreThesis'
import { GalleryScroll } from '@components/sections/GalleryScroll'
import { OpenTo } from '@components/sections/OpenTo'
import { ContactDecompile } from '@components/sections/ContactDecompile'
import { Scene } from '@components/three/Scene'
---

<Layout>
  <!-- WebGL Background - only on client, no SSR for Three.js -->
  <Scene client:only="react" />

  <!-- Noise overlay - pure CSS, no JS needed -->
  <div class="noise-overlay"></div>

  <!-- Scroll progress bar - magical gradient with section nodes -->
  <ScrollProgress client:load />

  <!-- Navigation - needs immediate interactivity -->
  <Nav client:load />

  <!-- Main Content -->
  <main class="relative">
    <!-- Hero - load immediately for LCP -->
    <Hero client:load />

    <!-- Video interlude - hydrate when visible -->
    <VideoInterlude
      client:visible
      src="/assets/fs/3130182-hd_1280_720_30fps.mp4"
      height="50vh"
      overlay="gradient"
    />

    <!-- Below-fold sections - hydrate when visible -->
    <CoreThesis client:visible />
    <GalleryScroll client:visible />
    <OpenTo client:visible />

    <!-- Contact + Footer - hydrate when visible -->
    <ContactDecompile client:visible />
  </main>
</Layout>

<!-- Lenis smooth scroll - uses a single shared RAF loop -->
<script>
  import Lenis from 'lenis'

  const lenis = new Lenis({
    duration: 1.2,
    easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
    orientation: 'vertical',
    gestureOrientation: 'vertical',
    smoothWheel: true,
    wheelMultiplier: 1,
    touchMultiplier: 2,
    infinite: false,
    autoRaf: false, // Don't create a separate RAF loop â€” we drive it ourselves
  })

  let lastTime = 0
  function raf(time: number) {
    // Throttle to ~60fps max to avoid unnecessary work on high-refresh displays
    if (time - lastTime >= 16) {
      lenis.raf(time)
      lastTime = time
    }
    requestAnimationFrame(raf)
  }

  requestAnimationFrame(raf)
</script>
